<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Task</title>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="Image_repository.js"></script>
    <script src="Names.js"></script>
    <script>
      //initializing number of trials per stage. Stage 1 should be up to 10, represents the number of trials per valence.
      //stage2*2 + stage3*2 <= 50. Stage 2 represents number per valence inside self/other type, stage 3 represents num per person.
      const STAGE_1_TRIALS_NUM = 10;
      const STAGE_2A_TRIALS_NUM = 25;
      const STAGE_2B_TRIALS_NUM = 25;
      const STAGE_3_TRIALS_NUM = 10;

      const STAGE_1_INT = 1;
      const STAGE_2_INT = 2;
      const STAGE_3_INT = 3;

      //Fast mode?
      const FASTMODE = true;

      //Waiting durations
      const PRE_TRIAL_BREAK =  5 ;

      const STIMULUS_PRESENTATION = FASTMODE? 100 : 2000;
      const ITI_PRESENTATION =  FASTMODE? 100 : 4000;
      const RESPONSE_PRESENTATION =  FASTMODE? 1000 :  4000;

      //Initializing variables for logics.js
      var firstCondResponses = [];
      var firstCondDiffenece = 0;
      const negativeImageAverage = -42.68;

      // initializing the result json
      var experimentResult = [];
    </script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-slider-response-modified.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-call-function.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
    <script src="logic.js"></script>
    <script src="Slides.js"></script>
    <script src="instruction_slides.js"></script>
    <link rel="stylesheet" href="jspsych-6.1.0/css/jspsych.css" />
    <link rel="stylesheet" href="./questioneir.css" />
   <style>

</style>

  </head>
  <body dir="ltr">
    <form id="genderForm" class="questionnaire-form">
      <div class="question">
          <label for="gender">?איך היית רוצה שיתייחסו אליך בניסוי</label>
      </div>
      <div class="options">
          <input type="radio" id="male" name="gender" value="male">
          <label for="male">בלשון זכר</label>
          <input type="radio" id="female" name="gender" value="female">
          <label for="female">בלשון נקבה</label>
      </div>
      <div class="ageQuestion">
        <input type="number" id="age" name="age">
        <label for="age">:גיל</label>
      </div>
      <input type="submit" value="בחר\י" class="submit-button">
  </form>
  
  
  
    
    <script>
      // this funciton starts the experiment
      function startExperiment(gender,age,cond,participantNum){
        const names =
        gender == "male"
          ? jsPsych.randomization.repeat(M_names, 1)
          : jsPsych.randomization.repeat(F_names, 1);

        //Create experiment objects
        var stage1Objects = !FASTMODE
          ? [TRAINING_NEG_IMAGES_OBJS[0]]
          : BASELINE_NEG_IMAGES_OBJS;

        var stage2Objects = !FASTMODE
          ? {
              other: [TRAINING_NEG_IMAGES_OBJS[0]],
              self: [TRAINING_NEG_IMAGES_OBJS[1]],
            }
          : {
              other: TRAINING_NEG_IMAGES_OBJS.slice(
                0,STAGE_2A_TRIALS_NUM),
              self: TRAINING_NEG_IMAGES_OBJS.slice(
                 STAGE_2A_TRIALS_NUM,
                 STAGE_2A_TRIALS_NUM + STAGE_2B_TRIALS_NUM)
            };

        for (var i = 0; i < stage2Objects.other.length; i++) {
          stage2Objects.other[i].name = names[i];
          stage2Objects.other[i].cond = cond;
        }

      var stage3Object = []
      for (var i = 0;i < STAGE_3_TRIALS_NUM;i++){
          var stage3TrialObject = {
            name:names[names.length - i -1 ],
            cond : cond,
            average:averageResponses[averageResponses.length -i -1 ]
          }
          stage3Object.push(stage3TrialObject);
        }

        Stage1Timeline = [];
        for (var i = 0; i < stage1Objects.length; i++) {
          Stage1Timeline.push(firstCond(stage1Objects[i],gender,STAGE_1_INT,age,participantNum));
        }
        var Stage1Full = {timeline:Stage1Timeline} 
        Stage2Timeline = [];
      for (var i = 0; i < stage2Objects.self.length; i++) {
        Stage2Timeline.push(
          firstCond(stage2Objects.self[i],gender,STAGE_2_INT,age,participantNum),
          otherCond(stage2Objects.other[i],gender,age,participantNum)
        );
      }
      var Stage2Full = {timeline:Stage2Timeline} 

      var stage3Timeline = []; 
      for (var i = 0; i < stage3Object.length; i++) {
        stage3Timeline.push(stage3SinglePerson(stage3Object[i],gender,age,participantNum));
      }
      var Stage3Full = {timeline:stage3Timeline} 

        
      // // // fullscrenStart,fullscrenEnd
        let timeline = gender == "male" ?
          [firstSlide,secondSlideMale,Stage1Full,calculateFirstCondDiffenece,thirdSlideMale,Stage2Full,forthSlideMale,Stage3Full,fifthSlideMale(gender,participantNum)]
        :[firstSlide,secondSlideFemale,Stage1Full,calculateFirstCondDiffenece,thirdSlideFemale,Stage2Full,forthSlideFemale,Stage3Full,fifthSlideFemale(gender,participantNum)]

      var allImages = TRAINING_NEG_IMAGES_OBJS;
      var IMAGES_TO_LOAD = [];
        for (var i = 0; i < allImages.length; i++) {
          IMAGES_TO_LOAD.push("stimuli/" + allImages[i].pic_num + ".jpg");
        }
        jsPsych.init({
          timeline: timeline,
          preload_images: IMAGES_TO_LOAD,
        });
      }

      document.getElementById("genderForm").addEventListener("submit",async function(event) {
        event.preventDefault(); // Prevent default form submission behavior
        // gets gender age and number of participant and caclulate cond 
        var kv = await getParticipantNum();
        const maleCounter = kv.maleCounter
        const femaleCounter = kv.femaleCounter

        var gender = document.querySelector('input[name="gender"]:checked').value;        
        const participantNum = gender == "male" ?maleCounter:femaleCounter;
        var cond = participantNum % 2 == 0 ? 1 : -1;
        var age = document.getElementById('age').value;
        console.log(gender);
        console.log(participantNum);

    //   // Start the experiment with the collected gender data
        startExperiment(gender,age,cond,participantNum);
      });
    
    </script>
  </body>
</html>