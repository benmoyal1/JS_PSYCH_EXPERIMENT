<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Task</title>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="Image_repository.js"></script>
    <script src="Names.js"></script>

    <script>
      //initializing number of trials per stage. Stage 1 should be up to 10, represents the number of trials per valence.
      //stage2*2 + stage3*2 <= 50. Stage 2 represents number per valence inside self/other type, stage 3 represents num per person.
      const STAGE_1_TRIALS_NUM = 5;
      const STAGE_2_TRIALS_NUM = 20;
      const STAGE_3_TRIALS_NUM = 10;

      //Fast mode?
      const FASTMODE = true;

      //Waiting durations
      const PRE_TRIAL_BREAK = FASTMODE ? 5 : 5000;

      //Choosing condition randomly, -1 = extreme, 1 = moderate
      const Condition = Math.floor(Math.random() * 2) == 0 ? -1 : 1;

      // var stage3Object = [
      //   {
      //     cond: -1,
      //     valence: "neg",
      //     name: names[names.length - 4],
      //     images: NEGATIVE_IMAGES_OBJS.slice(
      //       STAGE_2_TRIALS_NUM * 2,
      //       STAGE_2_TRIALS_NUM * 2 + STAGE_3_TRIALS_NUM - 1
      //     ),
      //   },
      //   {
      //     cond: 1,
      //     valence: "neg",
      //     name: names[names.length - 3],
      //     images: NEGATIVE_IMAGES_OBJS.slice(
      //       STAGE_2_TRIALS_NUM * 2 + STAGE_3_TRIALS_NUM,
      //       STAGE_2_TRIALS_NUM * 2 + STAGE_3_TRIALS_NUM * 2 - 1
      //     ),
      //   },
      //   {
      //     cond: -1,
      //     valence: "pos",
      //     name: names[names.length - 2],
      //     images: POSITIVE_IMAGES_OBJS.slice(
      //       STAGE_2_TRIALS_NUM * 2,
      //       STAGE_2_TRIALS_NUM * 2 + STAGE_3_TRIALS_NUM - 1
      //     ),
      //   },
      //   {
      //     cond: 1,
      //     valence: "pos",
      //     name: names[names.length - 1],
      //     images: POSITIVE_IMAGES_OBJS.slice(
      //       STAGE_2_TRIALS_NUM * 2 + STAGE_3_TRIALS_NUM,
      //       STAGE_2_TRIALS_NUM * 2 + STAGE_3_TRIALS_NUM * 2 - 1
      //     ),
      //   },
      // ];

      //Initializing variables for logics.js
      var firstCondResponses = { Negative: [], Positive: [] };
      var firstCondDiffenece = { Negative: 0, Positive: 0 };
      const positiveImageAverage = 38;
      const negativeImageAverage = -42;
    </script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-slider-response-modified.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-call-function.js"></script>
    
    <script src="experimentLoad.js"></script>
    <script src="logic.js"></script>
    <script src="Slides.js"></script>
    <script src="instruction_slides.js"></script>
    <link rel="stylesheet" href="jspsych-6.1.0/css/jspsych.css" />
    <style>
      body {
          background-color: black;
          color: white; 
      }
      #genderForm {
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }

      #genderForm label {
        color: white;
        margin-right: 10px;
      }

      #genderForm input[type="radio"] {
        margin-right: 5px;
      }

      #genderForm input[type="submit"] {
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin-top: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body dir="ltr">
    <form id="genderForm">
      <label for="gender">?איך היית רוצה שיתייחסו אליך בניסוי</label><br>
      <input type="radio" id="male" name="gender" value="male">
      <label for="male">בלשון זכר</label><br>
      <input type="radio" id="female" name="gender" value="female">
      <label for="female">בלשון נקבה</label><br>
      <input type="submit" value="בחר\י">
    </form>
    <script>



      async function sendDataToServer(data) {
    try {
        const response = await fetch('https://express-backend-exp.vercel.app/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ data: data })
        });
        const result = await response.json(); // Parse response as JSON
        console.log(result);
    } catch (error) {
        console.error('Error:', error);
    }
}
      // this funciton starts the experiment
      function startExperiment(gender){
        const names =
        gender == "Male"
          ? jsPsych.randomization.repeat(M_names, 1)
          : jsPsych.randomization.repeat(F_names, 1);

      //Create experiment objects
      var stage1Objects = FASTMODE
        ? [TRAINING_NEG_IMAGES_OBJS[0], TRAINING_POS_IMAGES_OBJS[0]]
        : TRAINING_POS_IMAGES_OBJS.slice(0, STAGE_1_TRIALS_NUM - 1).concat(
            TRAINING_NEG_IMAGES_OBJS.slice(0, STAGE_1_TRIALS_NUM - 1)
          );
      var stage2Objects = FASTMODE
        ? {
            other: [POSITIVE_IMAGES_OBJS[0], NEGATIVE_IMAGES_OBJS[0]],
            self: [POSITIVE_IMAGES_OBJS[1], NEGATIVE_IMAGES_OBJS[1]],
          }
        : {
            other: POSITIVE_IMAGES_OBJS.slice(0, STAGE_2_TRIALS_NUM - 1).concat(
              NEGATIVE_IMAGES_OBJS.slice(0, STAGE_2_TRIALS_NUM - 1)
            ),
            self: POSITIVE_IMAGES_OBJS.slice(
              STAGE_2_TRIALS_NUM,
              STAGE_2_TRIALS_NUM * 2 - 1
            ).concat(
              NEGATIVE_IMAGES_OBJS.slice(
                STAGE_2_TRIALS_NUM,
                STAGE_2_TRIALS_NUM * 2 - 1
              )
            ),
          };
      for (var i = 0; i < stage2Objects.other.length; i++) {
        stage2Objects.other[i].name = names[i];
      }
        var stage3Object = [
        {
          cond: -1,
          valence: "neg",
          name: names[names.length - 4],
          images: NEGATIVE_IMAGES_OBJS.slice(0,3),
        }
      ];


      Stage1Timeline = [];
      for (var i = 0; i < stage1Objects.length; i++) {
        Stage1Timeline.push(firstCond(stage1Objects[i],gender));
      }
      var Stage1Full = {timeline:Stage1Timeline} 
      Stage2Timeline = [];
    for (var i = 0; i < stage2Objects.self.length; i++) {
      Stage2Timeline.push(
        selfCond(stage2Objects.self[i],gender),
        otherCond(stage2Objects.other[i],gender)
      );
    }
    var Stage2Full = {timeline:Stage2Timeline} 

    var stage3Timeline = []; 
    for (var i = 0; i < stage3Object.length; i++) {
      stage3Timeline.push(stage3SinglePerson(stage3Object[i],gender));
    }
    var Stage3Full = {timeline:stage3Timeline} 

      timeline = gender == "male" ?
        [firstSlide,secondSlideMale,Stage1Full,thirdSlideMale,Stage2Full,forthSlideMale,Stage3Full,fifthSlideMale]
       :[firstSlide,secondSlideFemale,Stage1Full,thirdSlideFemale,Stage2Full,forthSlideFemale,Stage3Full,fifthSlideFemale]


            //Load Images
    var allImages = POSITIVE_IMAGES_OBJS.concat(NEGATIVE_IMAGES_OBJS)
    .concat(TRAINING_NEG_IMAGES_OBJS)
    .concat(TRAINING_POS_IMAGES_OBJS);
    var IMAGES_TO_LOAD = [];

      for (var i = 0; i < allImages.length; i++) {
        IMAGES_TO_LOAD.push("stimuli/" + allImages[i].pic_num + ".jpg");
      }
      jsPsych.init({
        timeline: timeline,
        preload_images: IMAGES_TO_LOAD,
        on_finish: function() {
        var expData = jsPsych.data.get();
        // sendDataToServer(data);
        const jsonData = [
      { name: 'John', age: 30, city: 'New York' },
      { name: 'Alice', age: 25, city: 'Los Angeles' },
      { name: 'Bob', age: 35, city: 'Chicago' }
      ];
        console.log(sendDataToServer(expData));


        }
      });}

      document.getElementById("genderForm").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent default form submission behavior
        // Get user's gender selection
        var gender = document.querySelector('input[name="gender"]:checked').value;
        // Start the experiment with the collected gender data
        startExperiment(gender);

      });
    
    </script>
  </body>
</html>