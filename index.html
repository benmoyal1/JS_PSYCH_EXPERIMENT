<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Task</title>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="Image_repository.js"></script>
    <script src="Names.js"></script>
    <script>
      //initializing number of trials per stage. Stage 1 should be up to 10, represents the number of trials per valence.
      //stage2*2 + stage3*2 <= 50. Stage 2 represents number per valence inside self/other type, stage 3 represents num per person.
      const STAGE_1_TRIALS_NUM = 1;
      const STAGE_2_TRIALS_NUM = 1;
      const STAGE_3_TRIALS_NUM = 1;

      const STAGE_1_INT = 1;
      const STAGE_2_INT = 2;
      const STAGE_3_INT = 3;

      //Fast mode?
      const FASTMODE = true;
      const FASTMODE_ = false;

      //Waiting durations
      const PRE_TRIAL_BREAK = FASTMODE ? 5 : 5000;

      const STIMULUS_PRESENTATION = FASTMODE_? 100 : 2000;
      const ITI_PRESENTATION =  FASTMODE_? 100 : 4000;
      const RESPONSE_PRESENTATION =  FASTMODE_? 1000 :  4000;
      //Choosing condition randomly, -1 = extreme, 1 = moderate
      const Condition = Math.floor(Math.random() * 2) == 0 ? -1 : 1;

      //Initializing variables for logics.js
      var firstCondResponses = [];
      var firstCondDiffenece = 0;
      const negativeImageAverage = -42.68;

      // initializing the result json
      var experimentResult = [];
    </script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-slider-response-modified.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-call-function.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
    <script src="experimentLoad.js"></script>
    <script src="logic.js"></script>
    <script src="Slides.js"></script>
    <script src="instruction_slides.js"></script>
    <link rel="stylesheet" href="jspsych-6.1.0/css/jspsych.css" />
   <style>
  body {
    background-color: black;
    color: white; 
    display: flex; /* Use flexbox */
    justify-content: center; /* Center horizontally */
    align-items: center; /* Center vertically */
    height: 100vh; /* Set the height of the body to full viewport height */
    margin: 0; /* Remove default margin */
  }
  
  #genderForm {
    padding: 20px;
    border-radius: 10px;
    text-align: center;
  }

  #genderForm label {
    color: white;
    margin-right: 10px;
    display: inline-block; /* Make labels appear on the same line */
    vertical-align: middle; /* Align labels vertically with the radio buttons */
  }

  #genderForm input[type="radio"] {
    margin-right: 5px;
    vertical-align: middle; /* Align radio buttons vertically with the labels */
  }

  #genderForm input[type="number"] {
    margin: 10px 0; /* Add some margin between age input and the radio buttons */
  }

  #genderForm input[type="submit"] {
    padding: 10px 20px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin-top: 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
</style>

  </head>
  <body dir="ltr">
    <form id="genderForm">
      <label for="gender">?איך היית רוצה שיתייחסו אליך בניסוי</label><br>
      <input type="radio" id="male" name="gender" value="male">
      <label for="male">בלשון זכר</label><br>
      <input type="radio" id="female" name="gender" value="female">
      <label for="female">בלשון נקבה</label><br>
      <input type="number" id="age" name="age">
      <label for="age">גיל:</label><br>
      <input type="submit" value="בחר\י">
    </form>
    
    <script>
      async function sendDataToServer(data_json) {
    try {
        const devUrl = 'http://localhost:3000/';
        const serverUrl = 'https://express-backend-exp.vercel.app/';
        const response = await fetch(serverUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ data: data_json })
        });
        const result = await response.json(); // Parse response as JSON
        return result;
    } catch (error) {
        console.error('Error:', error);
    }
}

      // this funciton starts the experiment
      function startExperiment(gender,age,cond){
        const names =
        gender == "male"
          ? jsPsych.randomization.repeat(M_names, 1)
          : jsPsych.randomization.repeat(F_names, 1);

        //Create experiment objects
        var stage1Objects = FASTMODE
          ? [TRAINING_NEG_IMAGES_OBJS[0]]
          : TRAINING_POS_IMAGES_OBJS.slice(0, STAGE_1_TRIALS_NUM - 1).concat(
              TRAINING_NEG_IMAGES_OBJS.slice(0, STAGE_1_TRIALS_NUM - 1)
            );
        var stage2Objects = FASTMODE
          ? {
              other: [NEGATIVE_IMAGES_OBJS[1]],
              self: [NEGATIVE_IMAGES_OBJS[3]],
            }
          : {
              other: NEGATIVE_IMAGES_OBJS.slice(0, STAGE_2_TRIALS_NUM - 1).concat(
                NEGATIVE_IMAGES_OBJS.slice(0, STAGE_2_TRIALS_NUM - 1)
              ),
              self: NEGATIVE_IMAGES_OBJS.slice(
                STAGE_2_TRIALS_NUM,
                STAGE_2_TRIALS_NUM * 2 - 1
              ).concat(
                NEGATIVE_IMAGES_OBJS.slice(
                  STAGE_2_TRIALS_NUM,
                  STAGE_2_TRIALS_NUM * 2 - 1
                )
              ),
            };
        for (var i = 0; i < stage2Objects.other.length; i++) {
          stage2Objects.other[i].name = names[i];
          stage2Objects.other[i].cond = cond;
          
        }

        var stage3Object = []

      for (var i = 0;i < STAGE_3_TRIALS_NUM;i++){
          var stage3TrialObject = {
            name:names[names.length - i -1 ],
            cond : i % 2 == 0 ? 1 : -1,
            average:averageResponses[averageResponses.length -i -1 ]

          }
          stage3Object.push(stage3TrialObject);
        }

        Stage1Timeline = [];
        for (var i = 0; i < stage1Objects.length; i++) {
          Stage1Timeline.push(firstCond(stage1Objects[i],gender,STAGE_1_INT,age));
        }
        var Stage1Full = {timeline:Stage1Timeline} 
        Stage2Timeline = [];
      for (var i = 0; i < stage2Objects.self.length; i++) {
        Stage2Timeline.push(
          firstCond(stage2Objects.self[i],gender,STAGE_2_INT,age),
          otherCond(stage2Objects.other[i],gender,age)
        );
      }
      var Stage2Full = {timeline:Stage2Timeline} 

      var stage3Timeline = []; 
      for (var i = 0; i < stage3Object.length; i++) {
        stage3Timeline.push(stage3SinglePerson(stage3Object[i],gender,age));
      }
      var Stage3Full = {timeline:stage3Timeline} 

        let timeline = gender == "male" ?
          [firstSlide,secondSlideMale,Stage1Full,calculateFirstCondDiffenece,thirdSlideMale,Stage2Full,forthSlideMale,Stage3Full,fifthSlideMale]
        :[firstSlide,secondSlideFemale,Stage1Full,calculateFirstCondDiffenece,thirdSlideFemale,Stage2Full,forthSlideFemale,Stage3Full,fifthSlideFemale]

        
        // let timeline = gender == "male" ?
        // [Stage2Full,forthSlideMale,Stage3Full,fifthSlideMale]
        // :[Stage1Full,calculateFirstCondDiffenece,thirdSlideFemale,Stage2Full,forthSlideFemale,Stage3Full,fifthSlideFemale]
        // // let timeline = gender == "male" ?
        // [Stage3Full,fifthSlideMale]
        // :[Stage3Full,fifthSlideMale]


      var allImages = NEGATIVE_IMAGES_OBJS.concat(TRAINING_NEG_IMAGES_OBJS);
      var IMAGES_TO_LOAD = [];
        for (var i = 0; i < allImages.length; i++) {
          IMAGES_TO_LOAD.push("stimuli/" + allImages[i].pic_num + ".jpg");
        }

        jsPsych.init({
          timeline: timeline,
          preload_images: IMAGES_TO_LOAD,
        });}


        startExperiment("male",'23',1);


      // document.getElementById("genderForm").addEventListener("submit", function(event) {
      //   event.preventDefault(); // Prevent default form submission behavior
      // //   // Get user's gender selection
      //   var gender = document.querySelector('input[name="gender"]:checked').value;
      //   var age = document.getElementById('age').value;
      //   var randomValue = Math.random();
      //   var cond = randomValue < 0.5 ? -1 : 1;

      // //   // Start the experiment with the collected gender data
      //   startExperiment(gender,age,cond);

      // });
    
    </script>
  </body>
</html>